<section
  id="results"
  class="w-full grid gap-4 grid-cols-[repeat(auto-fill,_minmax(210px,1fr))] py-20"
>
</section>
<script>
  const $ = (el: string) => document.querySelector(el);
  const $$ = (el: string) => document.querySelectorAll(el);

  const form = $("form")!;
  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const url = formData.get("url") as string;

    if (!url.trim()) {
      alert("Please enter a valid Spotify URL");
      return;
    }

    let trackId = "";
    try {
      trackId = new URL(url).pathname.split("/").pop() as string;
    } catch {
      if (url.length === 22) {
        trackId = url;
      } else {
        alert(`${url} is not a valid Spotify URL`);
        return;
      }
    }
    // add schema validation

    fetch(`/api/search?track=${trackId}`)
      .then((res) => res.json())
      .then((data) => {
        printHtmlNodes(data);
      })
      .catch((err) => {
        console.error(err);
      });

    const assets = {
      youtube: "/youtube-music.svg",
      spotify: "/spotify.svg",
      apple: "/apple-music.svg",
      deezer: "/deezer.svg",
      soundcloud: "/soundcloud.svg",
      musixmatch: "/musixmatch.png",
    };

    function printHtmlNodes(data: any[]) {
      const hero = $("#hero");
      const results = $("#results")!;

      hero?.remove();

      results.innerHTML = data
        .map((source) => {
          const [company, url] = Object.entries(source)[0];
          const asset = assets[company as keyof typeof assets];
          return `\
					<article class="relative animate-fade-in-up flex transition-transform hover:-translate-y-3">
						<a
							href=${url}
							target="_blank"
							rel="noopener noreferrer"
							class="flex flex-col items-center justify-center size-full border border-neutral-400/50 rounded-3xl p-6 bg-white/45"
						>
							${asset ? (company !== "deezer" ? `<img src=${asset} alt=${company} class="w-full block" />` : `<img src=${asset} alt=${company} class="w-full block" />`.repeat(3)) : `<h3 class="uppercase text-3xl font-semibold">${company}</h3>`}
						</a>
            <button id="clipboard" data-clipboard-text=${url} class="z-10 absolute top-0 right-0 p-2 transition-opacity hover:opacity-80 text-pink-400 cursor-pointer">
              <svg class="w-4 h-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>
            </button>
					</article>
				`;
        })
        .join("");

      const clipboard = $$("#clipboard")!;
      clipboard.forEach((button) => {
        button.addEventListener("click", (e) => {
          const target = e.target as HTMLButtonElement;
          const url = target.getAttribute("data-clipboard-text");
          navigator.clipboard.writeText(url!);
        });
      });
    }
  });
</script>
